name: Build StardewSkills (BetterHud + PAPI)

on:
  workflow_dispatch: {}
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2

      # ★ build.gradle 위치 자동 탐지 → PROJ 환경변수에 기록
      - name: Detect project dir
        shell: bash
        run: |
          echo "[Workspace]"; ls -la
          # 1) 루트
          if [ -f build.gradle ]; then
            PROJ="."
          # 2) 흔한 폴더명
          elif [ -f StardewSkills-BetterHud-PAPI/build.gradle ]; then
            PROJ="StardewSkills-BetterHud-PAPI"
          elif [ -f StardewSkills-BetterHud-PAPI-repo/build.gradle ]; then
            PROJ="StardewSkills-BetterHud-PAPI-repo"
          else
            # 3) 2단계까지 탐색
            CAND=$(find . -maxdepth 2 -type f -name build.gradle | head -n1 || true)
            if [ -n "$CAND" ]; then
              PROJ="$(dirname "$CAND")"
              PROJ="${PROJ#./}"
            else
              echo "::error::build.gradle not found anywhere"; exit 1
            fi
          fi
          echo "PROJ=$PROJ" >> "$GITHUB_ENV"
          echo "[Detect] Using project dir: $PROJ"

      - name: Build with Gradle
        shell: bash
        run: |
          cd "$PROJ"
          echo "[Build] pwd=$(pwd)"
          gradle build

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: stardewskills-jar
          path: |
            build/libs/*.jar
            ${{ github.workspace }}/$PROJ/build/libs/*.jar
          if-no-files-found: error
